#upload the data
datos <- readRDS("data/MatrizDatosFinalesAves.rds")

#check that the data were uploaded correctly
# (avoid interactive commands in scripts)

#the names of the first column are separated by " ", so we are going to change it
#to "_"
nombres_fila <- rownames(datos)
nombres_fila <- gsub(" ", "_", nombres_fila)
rownames(datos) <- nombres_fila

#organize species in alphabetical order
datos <- datos[order(rownames(datos)), , drop = FALSE]


#we are going to organize the matrix to perform functional diversity analyses
#to transpose the data matrix so that species are in the columns and communities
#in the rows

comunidadesGBIF <- t(datos)


##Check that all species are present in at least one community
#1) Row sums to verify that each community has at least one species

totalComunidades <- rowSums(comunidadesGBIF)

#Column sums to verify that species are represented in at least
#one community

totalespecies <- colSums(comunidadesGBIF)


#remove species that are not recorded in any community
#1) remove species from the community matrix

totalespecies <- colSums(comunidadesGBIF > 0) > 0
comunidadesFinal <- comunidadesGBIF[, totalespecies, drop = FALSE]


#we are going to upload the Conney 2021 matrix and from this we are going to build the
#final community matrix that only contains species with coloration measurements

medicionesColor <- read.csv("data/Conney2021.csv", stringsAsFactors = FALSE)

#standardize species names in coloration data to match community matrix
medicionesColor$Species <- gsub(" ", "_", medicionesColor$Species)


#Now we are going to build the community matrix only with the species names
#that have coloration measurements

#get the species names in medicionesColor
speciesInMedicionesColor <- medicionesColor$Species


#filter the columns of comunidadesFinal that are present in medicionesColor
comunidadesFinal <- comunidadesFinal[
  , colnames(comunidadesFinal) %in% speciesInMedicionesColor,
  drop = FALSE
]


#check dimensions of the final community matrix
dim(comunidadesFinal)


#check if output directory exists, if not create it
if (!dir.exists("output")) {
  dir.create("output")
}


#export the final community data matrix (only species with coloration data)
write.csv(
  comunidadesFinal,
  "output/comunidades_final.csv",
  row.names = TRUE
)


#we create a vector with the species names present in the final community matrix
#this will be used later to build male and female coloration dataframes

speciesInComunidadesFinal <- colnames(comunidadesFinal)

#we are going to create a new dataframe only taking into account the species present in
#both dataframes and keeping the columns with species name, sex and coloration measurements

medicionesColorFinal <- medicionesColor[
  medicionesColor$Species %in% speciesInComunidadesFinal,
  c(1, 2, 5, 6)
]


#organize in alphabetical order
medicionesColorFinal <- medicionesColorFinal[
  order(medicionesColorFinal$Species),
  ,
  drop = FALSE
]


#2) now we are going to create a dataframe for coloration measurements for females and males

#for females
hembras <- medicionesColorFinal[medicionesColorFinal$Sex == "F", , drop = FALSE]


#organize the matrix so that the first column is used as row names
#and remove the Sex column

rownames(hembras) <- hembras$Species
hembras <- hembras[, -which(colnames(hembras) %in% c("Species", "Sex")), drop = FALSE]


#for males
machos <- medicionesColorFinal[medicionesColorFinal$Sex == "M", , drop = FALSE]


#organize the matrix so that the first column is used as row names
#and remove the Sex column

rownames(machos) <- machos$Species
machos <- machos[, -which(colnames(machos) %in% c("Species", "Sex")), drop = FALSE]


##DIVERSITY ANALYSES##

#Functional diversity analyses
#1) we load the libraries
#(packages must be installed previously)

library(dplyr)
library(FD)
library(Rcpp)
library(hillR)


#Hill numbers–based analyses
fd_0 <- hill_func(
  comm   = comunidadesFinal,
  traits = hembras,
  q      = 0
)


#Functional space–based analyses for FEMALES
#we upload the trait-type data matrix

variablesBD <- read.csv("data/VariablesBD.csv", stringsAsFactors = FALSE)


library(mFD)


#we transform the community matrix into an abundance matrix
Mat_AbundanciasH <- as.matrix(comunidadesFinal)


#we calculate the species trait distance matrix using female coloration traits
sp_distH <- mFD::funct.dist(
  sp_tr  = hembras,
  tr_cat = variablesBD,
  metric = "euclidean"
)


#we evaluate the quality of the functional space
fspaces_qualityH <- mFD::quality.fspaces(
  sp_dist     = sp_distH,
  maxdim_pcoa = 2
)


#get species coordinates in the functional space
sp_faxes_coordH <- fspaces_qualityH$details_fspaces$sp_pc_coord


#we calculate alpha functional diversity indices
alpha_fd_indicesH <- mFD::alpha.fd.multidim(
  sp_faxes_coord = sp_faxes_coordH[, c("PC1", "PC2")],
  asb_sp_w       = Mat_AbundanciasH,
  ind_vect       = c("feve", "fric", "fdiv", "fspe"),
  scaling        = TRUE,
  check_input    = TRUE,
  details_returned = TRUE
)


ResultadosHembras <- alpha_fd_indicesH$functional_diversity_indices


#we export the female results
write.table(
  ResultadosHembras,
  "output/resultadosHembras.txt",
  sep = "\t",
  row.names = TRUE
)


#Functional space–based analyses for MALES

#we transform the community matrix into an abundance matrix
Mat_AbundanciasM <- as.matrix(comunidadesFinal)


#we calculate the species trait distance matrix using male coloration traits
sp_distM <- mFD::funct.dist(
  sp_tr  = machos,
  tr_cat = variablesBD,
  metric = "euclidean"
)


#we evaluate the quality of the functional space
fspaces_qualityM <- mFD::quality.fspaces(
  sp_dist     = sp_distM,
  maxdim_pcoa = 2
)


#get species coordinates in the functional space
sp_faxes_coordM <- fspaces_qualityM$details_fspaces$sp_pc_coord












#we calculate alpha functional diversity indices for MALES

alpha_fd_indicesM <- mFD::alpha.fd.multidim(
  sp_faxes_coord = sp_faxes_coordM[, c("PC1", "PC2")],
  asb_sp_w       = Mat_AbundanciasM,
  ind_vect       = c("feve", "fric", "fdiv", "fspe"),
  scaling        = TRUE,
  check_input    = TRUE,
  details_returned = TRUE
)


resultadosMachos <- alpha_fd_indicesM$functional_diversity_indices


#we export the male results
write.table(
  resultadosMachos,
  "output/resultadosMachos.txt",
  sep = "\t",
  row.names = TRUE
)


######################STATISTICAL TESTS#####################################

#we are going to perform ANOVA
#1) we load the packages

library(dplyr)
library(rstatix)
library(ggpubr)


#2) we organize the data matrices in order to run the ANOVA
#we create a new dataframe from ResultadosHembras adding a new column Sex = "H" for females

hembrasANOVA <- data.frame(
  Sex = rep("H", nrow(ResultadosHembras)),
  ResultadosHembras,
  row.names = rownames(ResultadosHembras)
)

nombres_columnas <- names(ResultadosHembras)
names(hembrasANOVA) <- c("Sex", nombres_columnas)


#we create a new dataframe from resultadosMachos adding a new column Sex = "M" for males

machosANOVA <- data.frame(
  Sex = rep("M", nrow(resultadosMachos)),
  resultadosMachos,
  row.names = rownames(resultadosMachos)
)

nombres_columnasM <- names(resultadosMachos)
names(machosANOVA) <- c("Sex", nombres_columnasM)


#we continue organizing the matrix, now we add a new column Habitat
#to distinguish urban and rural communities for females

hembrasANOVA$MuniID <- substr(rownames(hembrasANOVA), 1, 5)
hembrasANOVA$Habitat <- "Urban"
hembrasANOVA$Habitat[substr(rownames(hembrasANOVA), 7, 7) == "R"] <- "Rural"


#we continue organizing the matrix, now we add a new column Habitat
#to distinguish urban and rural communities for males

machosANOVA$MuniID <- substr(rownames(machosANOVA), 1, 5)
machosANOVA$Habitat <- "Urban"
machosANOVA$Habitat[substr(rownames(machosANOVA), 7, 7) == "R"] <- "Rural"


#we merge the female and male dataframes
datosANOVA <- rbind(hembrasANOVA, machosANOVA)


#3) now we run the ANOVA
datosANOVA$Sex     <- as.factor(datosANOVA$Sex)
datosANOVA$Habitat <- as.factor(datosANOVA$Habitat)
datosANOVA$MuniID  <- as.factor(datosANOVA$MuniID)






#we obtain descriptive statistics by Sex and Habitat
datosANOVA %>%
  group_by(Sex, Habitat) %>%
  get_summary_stats(fric, type = "mean_sd")


#BOXPLOT
bxp <- ggboxplot(
  datosANOVA,
  x     = "Habitat",
  y     = "fric",
  color = "Sex",
  palette = "jco"
)
bxp


#ASSUMPTIONS
#1) OUTLIERS
datosANOVA %>%
  group_by(Sex, Habitat) %>%
  identify_outliers(fric)
#this is checked!!


#NORMALITY
datosANOVA %>%
  group_by(Sex, Habitat) %>%
  shapiro_test(fric)


#normal if alpha = 0.01, but this was not accepted
datosANOVA %>%
  group_by(Habitat) %>%
  levene_test(fric ~ Sex)
#HOMOGENEITY BETWEEN RURAL AND URBAN


datosANOVA %>%
  group_by(Sex) %>%
  levene_test(fric ~ Habitat)
#HOMOGENEITY OF VARIANCES BETWEEN SEXES


#HOMOGENEITY OF COVARIANCES
box_m(datosANOVA[, "fric", drop = FALSE], datosANOVA$Sex)
#FULL COVARIANCE FOR SEX AND HABITAT

box_m(datosANOVA[, "fric", drop = FALSE], datosANOVA$Habitat)


#Two-way mixed ANOVA test
res.aov <- anova_test(
  data   = datosANOVA,
  dv     = fric,
  wid    = MuniID,
  within = c(Habitat, Sex)
)

get_anova_table(res.aov)


#paired t-tests
TTESTHEMBRASPAREADA <- t.test(
  datosANOVA$fric[1:33],
  datosANOVA$fric[34:66],
  paired = TRUE
)

TTESTMACHOSPAREADA <- t.test(
  datosANOVA$fric[67:99],
  datosANOVA$fric[100:132],
  paired = TRUE
)


##RESIDUALS
datosANOVA$ResFric <- as.numeric(
  residuals(lm(datosANOVA$fric ~ datosANOVA$sp_richn))
)


#BOXPLOT OF RESIDUALS
bxp <- ggboxplot(
  datosANOVA,
  x     = "Habitat",
  y     = "ResFric",
  color = "Sex",
  palette = "jco"
)
bxp


#1) OUTLIERS
datosANOVA %>%
  group_by(Sex, Habitat) %>%
  identify_outliers(ResFric)
#this is checked!!





#NORMALITY OF RESIDUALS
datosANOVA %>%
  group_by(Sex, Habitat) %>%
  shapiro_test(ResFric)


#normal if alpha = 0.01, but this was not accepted
datosANOVA %>%
  group_by(Habitat) %>%
  levene_test(ResFric ~ Sex)
#HOMOGENEITY BETWEEN RURAL AND URBAN


datosANOVA %>%
  group_by(Sex) %>%
  levene_test(ResFric ~ Habitat)
#HOMOGENEITY OF VARIANCES BETWEEN SEXES


#HOMOGENEITY OF COVARIANCES
box_m(datosANOVA[, "ResFric", drop = FALSE], datosANOVA$Sex)
#FULL COVARIANCE FOR SEX AND HABITAT

box_m(datosANOVA[, "ResFric", drop = FALSE], datosANOVA$Habitat)


#Two-way mixed ANOVA test using residuals
res.aov <- anova_test(
  data   = datosANOVA,
  dv     = ResFric,
  wid    = MuniID,
  within = c(Habitat, Sex)
)

get_anova_table(res.aov)


#descriptive statistics of residuals
datosANOVA %>%
  group_by(Sex, Habitat) %>%
  get_summary_stats(ResFric, type = "mean_sd")


##ANOVA WITH PERMUTATIONS

library(permuco)

#we create a unique ID combining municipality and sex
datosANOVA$MuniIDS <- paste0(datosANOVA$MuniID, datosANOVA$Sex)

resultadosfinalFdiv <- aovperm(
  fdiv ~ Sex * Habitat + Error(MuniIDS / (Habitat)),
  data = datosANOVA,
  np   = 50000
)

resultadosfinalFdiv


##NOW WE CREATE FIGURES USING A VIOLIN PLOT

library(ggplot2)

ggplot(datosANOVA, aes(x = Habitat, y = fdiv, fill = Sex)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, position = position_dodge(0.9)) + 
  labs(
    title = "Comparison of coloration patterns in passerines",
    x     = "Habitat",
    y     = "Coloration (FDiv)"
  ) +
  theme_minimal() +
  scale_fill_manual(
    name   = "Sex",
    values = c("deepskyblue4", "deepskyblue"),
    labels = c("Females", "Males")
  ) +
  theme(
    panel.border     = element_rect(color = "black", fill = NA, size = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line        = element_line(color = "black")
  )


#MULTIPLICATION DUE TO INTERACTION
#(model Mod2 is assumed to be defined previously)
summary(Mod2)


#now we perform the ANOVA taking into account the effect of species richness
#on coloration calculations
#1) we run the correlation between richness and FDiv

correlacionFDiv <- cor.test(
  datosANOVA$sp_richn,
  datosANOVA$fdiv
)

summary(lm(datosANOVA$sp_richn ~ datosANOVA$fdiv))

correlacionFDiv


##NOW WE EVALUATE THE EFFECT OF SPECIES RICHNESS ON FUNCTIONAL DIVERSITY (FRic)

correlacionFRic <- cor.test(datosANOVA$sp_richn, datosANOVA$fric)

summary(lm(sp_richn ~ fric, data = datosANOVA))

correlacionFRic


#3) NOW WE PLOT THE CORRELATION

plot(
  datosANOVA$sp_richn,
  datosANOVA$fric,
  xlab = "Species richness",
  ylab = "Color space (FRic)",
  pch  = 19,
  col  = "gray"
)

text(
  x      = max(datosANOVA$sp_richn) * 0.7,
  y      = max(datosANOVA$fric) * 0.9,
  labels = paste("Correlation:", round(correlacionFRic$estimate, 2))
)


##NOW WE CONTROL FOR SPECIES RICHNESS
#(extract residuals from the regression)

modelo_fric <- lm(fric ~ sp_richn, data = datosANOVA)
datosANOVA$ResFric <- residuals(modelo_fric)


##NOW WE EVALUATE HOW COMMUNITIES OCCUPY FUNCTIONAL SPACE
#(mixed ANOVA with permutations)

resultadosFRichPermutaciones <- aovperm(
  ResFric ~ Sex * Habitat + Error(MuniIDS / (Habitat)),
  data = datosANOVA,
  np   = 50000
)

resultadosFRichPermutaciones


##NOW WE PLOT THE RESULTS BASED ON RESIDUALS

ggplot(datosANOVA, aes(x = Habitat, y = ResFric, fill = Sex)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, position = position_dodge(0.9)) + 
  labs(
    title = "Comparison of coloration patterns in passerines",
    x     = "Habitat",
    y     = "Color space (FRic)"
  ) +
  theme_minimal() +
  scale_fill_manual(
    name   = "Sex",
    values = c("deepskyblue4", "deepskyblue"),
    labels = c("Females", "Males")
  ) +
  theme(
    panel.border     = element_rect(color = "black", fill = NA, size = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line        = element_line(color = "black")
  )


##EXPLORATORY PLOT OF COLOR LOCI (MALES)

plot(
  machos$LociVS,
  machos$LociUVS,
  xlab = "LociVS",
  ylab = "LociUVS",
  pch  = 19,
  col  = "gray"
)
